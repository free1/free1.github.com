<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
    <meta name="author" content="Free" />
    <meta name="generator" content="Jekyll 1.0.2" />
    <meta name="description" content="Rails(转载)" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    
    <link rel="stylesheet" type="text/css" href="/css/post.css" media="all" />

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

    <script type="text/javascript" src="/js/compatible.js"></script>

</head>
	<body>
		<div id="Previous">
			<a href="http://free1.github.com/"> <-Home </a>
		</div>

		<div id="Title">
	    	<h1>Rails Routes</h1>
	    	<p><b>27 Aug 2013</b>, by <b>Free</b></p>
		</div>

		<div id="Post">
	    	<article id="articlePost">
	        	<p><a href="http://ruby-china.org/topics/15270">Rails Routes 中的两件事</a></p>

<p>写在前面：在看devise的源码过程中，发现Devise在做Routes Mapping时，使用了Rails自己的@constraints。于是查查文档，笔记两件事。</p>

<p>以下内容粗略翻译自Ruby on Rails 4.0.1， ActionDispatch::Routing::Mapper::Scoping 。</p>

<p>位置：actionpack/lib/action_dispatch/routing/mapper.rb
第一件事，通过routes访问资源。</p>

<p>这种写法很熟悉的。</p>

<p>namespace &quot;admin&quot; do
  resources :posts, :comments
end</p>

<p>那么，访问/posts，调用 Admin::PostsController 时，如何写呢？</p>

<p>scope module: &quot;admin&quot; do
  resources :posts
end</p>

<p>或者</p>

<p>resources :posts, module: &quot;admin&quot;</p>

<p>当然，反过来，访问 /admin/posts 时，调用 PostsController，就这么写：</p>

<p>scope &quot;/admin&quot; do
  resources :posts
end</p>

<p>或者</p>

<p>resources :posts, path: &quot;/admin/posts&quot;</p>

<p>第二件事，限制访问。</p>

<p>比如允许 /posts/1.1 访问，而禁止 /posts/1，那么代码如下：</p>

<p>constraints(id: /\d+.\d+/) do
  resources :posts
end</p>

<p>在其他的资源引用上，也可以做如下限制：</p>

<p>resources :posts do
  constraints(post_id: /\d+.\d+/) do
    resources :comments
  end
end</p>

<p>限制ip访问，比如 只允许 192.168.* 访问资源：</p>

<p>constraints(ip: /192.168.\d+.\d+/) do
  resources :posts
end</p>

<p>动态请求时的匹配，比如下面的这个限制：</p>

<p>constraints(lambda { |req| req.env[&quot;HTTP<em>USER</em>AGENT&quot;] =~ /iPhone/ }) do
  resources :iphones
end</p>

<p>当然你也可以把它放到model里：</p>

<p>class Iphone
  def self.matches?(request)
    request.env[&quot;HTTP<em>USER</em>AGENT&quot;] =~ /iPhone/
  end
end</p>

<p>下面这句话有待验证，暂时不译：</p>

<p>An expected place for this code would be lib/constraints.</p>

<p>This class is then used like this:</p>

<p>constraints(Iphone) do
  resources :iphones
end</p>

	    	</article>

	    	
				<div style="height: 64px"></div>
    		
		</div>
		
	</body>
</html>


 
   
       